---
title: "Beta-carotene CHD triangulation example"
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
    number_sections: true
vignette: >
  %\VignetteIndexEntry{Beta-carotene CHD triangulation example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(dplyr)
library(tidyr)
library(readxl)
library(tibble)
library(magrittr)
library(metafor)
library(triangulate)
```

## Introduction

This tutorial demonstrates how to use the `triangulate` package to perform a bias-adjusted meta-analysis of the association between beta-carotene and coronary heart disease (CHD), using estimates from diverse study designs (RCTs, observational, and MR).

## 1. Create CHD Dataset

We define estimates from different study designs and harmonise them to a common dose-response scale.

```{r create-data}
# Diet-based observational studies
CHD_diet <- data.frame(
  Author = c("Osganian", "Klipstein-Grobusch", "Todd", "Pandey"),
  RR = c(0.83, 0.22, 0.87, 0.84),
  RR_LC = c(0.72, 0.07, 0.68, 0.66),
  RR_UC = c(0.96, 0.68, 1.12, 1.09),
  Study = rep("Obs", 4),
  Design = rep("Diet", 4),
  Dose = rep(1, 4)
)

# Circulatory biomarker studies (convert to per 5000 ug/d)
sd_circ <- sqrt(78) * (((0.48 - 0.46) / 0.01863) / 3.92)
sd_diet <- sqrt(67) * ((4465.5 - 3383.8) / 3.92)
conv_factor <- 0.27 * (sd_diet / sd_circ)

CHD_circ <- data.frame(
  Author = c("Karppi", "Koh", "Hak"),
  RR = c(0.64, 0.95, 0.82),
  RR_LC = c(0.45, 0.66, 0.63),
  RR_UC = c(0.93, 1.37, 1.07),
  Study = rep("Obs", 3),
  Design = rep("Circ", 3),
  Dose = rep(25 * conv_factor, 3)
) %>%
  mutate(
    RR = exp((5000 / Dose) * log(RR)),
    RR_LC = exp((5000 / Dose) * log(RR_LC)),
    RR_UC = exp((5000 / Dose) * log(RR_UC)),
    Dose = Dose^0
  )

# RCT studies
CHD_rct <- data.frame(
  Author = c("Tornwall", "Cook", "Hennekens"),
  RR = c(1.03, 1.00, 0.96),
  RR_LC = c(0.92, 0.89, 0.85),
  RR_UC = c(1.16, 1.13, 1.08),
  Study = rep("RCT", 3),
  Design = rep("RCT", 3),
  Dose = c(20000, 25000, 25000)
) %>%
  mutate(
    RR = exp(log(RR) / (Dose / 5000)),
    RR_LC = exp(log(RR_LC) / (Dose / 5000)),
    RR_UC = exp(log(RR_UC) / (Dose / 5000)),
    Dose = Dose^0
  )

# Mendelian Randomisation (MR) studies
sd_circ <- sqrt(78) * ((((0.48 - 0.46) * 10) / 0.01863) / 3.92)
sd_diet <- sqrt(67) * ((4465.5 - 3383.8) / 3.92)
conv_factor <- 0.27 * (sd_diet / sd_circ)

CHD_MR <- data.frame(
  Author = c("CARDIoGRAMplusC4D", "UKBB", "FinnGen"),
  RR = c(exp((5000 / conv_factor) * (log(1.054) / 301)),
         exp((5000 / conv_factor) * (log(1.015) / 301)),
         exp((5000 / conv_factor) * (log(1.027) / 301))),
  RR_LC = c(exp((5000 / conv_factor) * (log(0.948) / 301)),
            exp((5000 / conv_factor) * (log(0.925) / 301)),
            exp((5000 / conv_factor) * (log(0.840) / 301))),
  RR_UC = c(exp((5000 / conv_factor) * (log(1.173) / 301)),
            exp((5000 / conv_factor) * (log(1.114) / 301)),
            exp((5000 / conv_factor) * (log(1.255) / 301))),
  Study = rep("MR", 3),
  Design = rep("Circ", 3),
  Dose = rep(1, 3)
)

# Combine all
Metadta_all_CHD <- bind_rows(CHD_diet, CHD_circ, CHD_rct, CHD_MR) %>%
  mutate(
    logRR = log(RR),
    se_logRR = (log(RR_UC) - log(RR_LC)) / 3.92,
    id = 1:n(),
    Outcome = "CHD"
  ) %>%
  select(Author, Study, id, Dose, logRR, se_logRR, Design, Outcome)
```

## 2. Merge with RoB Assessments

```{r merge-rob}
rob_file <- system.file("extdata", "beta_carotene_data.xlsx", package = "triangulate")
RoB <- readxl::read_excel(rob_file, sheet = "main_data")
colnames(RoB)[2] <- "Author"

Metadta_RoB_CHD<-merge(Metadta_all_CHD, RoB, by="Author")

# format to robviz
colnames(Metadta_RoB_CHD)[which(colnames(Metadta_RoB_CHD)=="id")]<-"result_id"
colnames(Metadta_RoB_CHD)[which(colnames(Metadta_RoB_CHD)=="Study")]<-"type"
colnames(Metadta_RoB_CHD)[which(colnames(Metadta_RoB_CHD)=="Author")]<-"study"
colnames(Metadta_RoB_CHD)[which(colnames(Metadta_RoB_CHD)=="logRR")]<-"yi"
Metadta_RoB_CHD["vi"]<-Metadta_RoB_CHD["se_logRR"]^2

Metadta_RoB_CHD$study<-as.character(Metadta_RoB_CHD$study)
Metadta_RoB_CHD$type<-as.character(Metadta_RoB_CHD$type)
Metadta_RoB_CHD$Design<-as.character(Metadta_RoB_CHD$Design)

dat_CHDbias<-as_tibble(Metadta_RoB_CHD)
```

## 3. Format & Validate Input

```{r validate}
tri_dat_check(dat_CHDbias)

# Replace NA with "None"
dat_CHDbias[is.na(dat_CHDbias)] <- "None"

# Convert to long bias format
dat_CHDbias_rob <- dat_CHDbias %>%
  tri_to_long() %>%
  tri_absolute_direction() %>%
  tri_to_wide()
```

## 4. Add Indirectness (set to missing)

```{r indirect}
dat_CHDind <- dat_CHDbias %>% select(result_id, study, type, yi, vi)

for (j in paste0("d", 1:3)) {
  dat_CHDind[[paste0(j, "j")]] <- "None"
  dat_CHDind[[paste0(j, "t")]] <- "None"
  dat_CHDind[[paste0(j, "d")]] <- "None"
}

# Convert to long and append
dat_CHDind <- dat_CHDind %>%
  tri_to_long() %>%
  tri_absolute_direction() %>%
  tri_append_indirect(triangulate::dat_ind_values)
```

## 5. Apply Bias Priors & Estimate Adjusted Effects

```{r bias-correction}
custom_bias_priors <- triangulate::dat_bias_values %>%
  add_row(
    domain = 'all', j = 'critical',
    bias_m_add = 0.36, bias_v_add = 0.2,
    bias_m_prop = 0.12, bias_v_prop = 0.064
  )

dat_CHDbias_prep <- dat_CHDbias %>%
  tri_to_long() %>%
  tri_absolute_direction() %>%
  tri_append_bias(custom_bias_priors)

datCHD_final <- tri_prep_data(dat_CHDbias_prep, dat_CHDind)
```

## 6. Generate Bias-Adjusted Plot

```{r plot, fig.width=10, fig.height=8}

### Plot adjusted with robviz
dat_CHDbias_final <- dat_CHDbias_rob %>%
  right_join(datCHD_final[c("result_id", "yi_adj", "vi_adj")], by = "result_id")

dat_plot <- left_join(dat_CHDbias, datCHD_final[, c("result_id", "yi_adj", "vi_adj")])
tri_plot_bias_direction(dat_plot)

```
